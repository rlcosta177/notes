na aws -> click the server -> actions -> networking -> Change source/destination check -> check the box 'stop'

sudo apt update && sudo apt upgrade -y
sudo apt install netfilter-persistent iptables-persistent
nano /etc/sysctl.conf -> uncomment: net.ipv4.ip_forward=1

<details>
  <summary>reference for prerouting, input, forward, output, postrouting: https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture</summary>
  <br>
    https://pastebin.com/SxhJmhrm
</details>


<details>
<summary>reference for the NAT and FILTER tables(jdaniel email)</summary>
<br>
# Generated by iptables-save v1.6.0 on Thu Nov 24 23:42:12 2020
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]
-A INPUT -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -s 10.0.0.0/30 -p icmp -m icmp --icmp-type 8 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A INPUT -m limit --limit 3/min -j LOG --log-prefix "IPTABLES:INPUT:Denied: " --log-level 7
-A INPUT -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -d 172.16.0.2/32 -p tcp -m tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 172.16.0.2/32 -p tcp -m tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -d 192.168.0.2/32 -p tcp -m tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 192.168.0.2/32 -p tcp -m tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 172.16.0.0/30 -d 192.168.0.2/32 -p tcp -m tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 192.168.0.2/32 -d 172.16.0.0/30 -p tcp -m tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p tcp -m tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p tcp -m tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p tcp -m tcp --sport 20 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p tcp -m tcp --dport 20 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p tcp -m tcp --sport 21 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p tcp -m tcp --dport 21 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p icmp -m icmp --icmp-type 8 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p icmp -m icmp --icmp-type 0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 172.16.0.0/30 -d 192.168.0.0/30 -p icmp -m icmp --icmp-type 8 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 192.168.0.0/30 -d 172.16.0.0/30 -p icmp -m icmp --icmp-type 0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p udp -m udp --sport 53 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p udp -m udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -m limit --limit 3/min -j LOG --log-prefix "iptables_FORWARD_denied: " --log-level 7
-A FORWARD -j REJECT --reject-with icmp-port-unreachable
-A OUTPUT -p icmp -m icmp --icmp-type 8 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -d 10.0.0.0/30 -p icmp -m icmp --icmp-type 0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p icmp -m icmp --icmp-type 0 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
-A OUTPUT -m limit --limit 3/min -j LOG --log-prefix "IPTABLES:FORWARD:Denied: " --log-level 7
-A OUTPUT -j REJECT --reject-with icmp-port-unreachable
COMMIT
# Completed on Thu Nov 24 23:42:12 2020


#
# Outros exemplos - situações específicas
#
#bloquear tudo
iptables –P INPUT DROP
iptables –P OUTPUT DROP
iptables –P FORWARD DROP

#Para conseguir ter acesso a si mesmo
iptables –A INPUT –i lo –j ACCEPT
iptables –A OUTPUT –o lo –j ACCEPT

#Permitir ICMP
iptables -A INPUT -p icmp  -j ACCEPT
iptables -A OUTPUT -p icmp -j ACCEPT
iptables -A FORWARD -p icmp -j ACCEPT

#Permitir Regra Individual
iptables –A INPUT -i * –p tcp –-dport * -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
iptables –A OUTPUT -o * –p tcp –-sport * –m state --state RELATED,ESTABLISHED –j ACCEPT

iptables –A FORWARD -i * –p tcp –-dport * -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
iptables –A FORWARD -o * –p tcp –-sport * –m state --state RELATED,ESTABLISHED –j ACCEPT
iptables –A FORWARD -i * –p tcp –-dport * -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables –A FORWARD -o * –p tcp –-sport * –m state --state NEW,RELATED,ESTABLISHED –j ACCEPT


#Permitir Regras de Múltiplas Portas
iptables -A INPUT -p tcp/udp -i interface -m  multiport --dport X,X,X,X,X  -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp/udp -o interface -m  multiport --sport X,X,X,X,X -m state --state RELATED,ESTABLISHED -j ACCEPT

iptables -A FORWARD -p tcp/udp -i interface -m  multiport --dport X,X,X,X,X  -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p tcp/udp -o interface -m  multiport --sport X,X,X,X,X -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p tcp/udp -i interface -m  multiport --dport X,X,X,X,X  -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p tcp/udp -o interface -m  multiport --sport X,X,X,X,X -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT

#NAT/PAT - OUTSIDE
iptables -t nat -A POSTROUTING -o interface -j MASCARADE

#NAT - INSIDE - PORT FORWADING - Múltiplas Portas
iptables -t nat -A PREROUTING -i interface -p tcp/udp -m multiport --dport X,X,X,X -j DNAT --to-destination X.X.X.X  

#NAT - INSIDE - PORT FORWADING - Portas Individuais
iptables -t nat -A PREROUTING -i interface -p tcp/udp --dport X -j DNAT --to-destination X.X.X.X

#NAT - INSIDE - PORT FORWADING - Encaminhar todo o tráfico
iptables -t nat -A PREROUTING -i interface -j DNAT --to-destination X.X.X.X

apt-get install netfilter-persistent iptables-persistent

netfilter-persistent flush - limpa a memória e coloca todas as tables [filter, net, raw, mangle, security] em ACCEPT
netfilter-persistent reload - copia de /etc/iptables/rules.v4 para a memória
netfilter-persistent save  - Uso este comando para guardar em /etc/iptables/rules.v4 as regras da firewall que estão em memória

#Criar Falso Servidor de Echo - TCP
socat -v tcp-l:1234,fork exec:'/bin/cat' &
#Criar Falso Servidor de Echo - TCP
socat -v udp-l:1234,fork exec:'/bin/cat' &

#Testar Portas de Servidor - TCP
netcat -u host port
#Testar Portas de Servidor - UDP
netcat -u host port

cd /proc
find . | grep vlan
ipv4.conf.ens33.proxy_arp_pvlan=1
</details>

no srv instalar bind9, bind9-utils bind9-dns..., bind9-doc
no srv cd /etc/bind -> nano named.conf.options:
    forwarders {
            8.8.8.8;
    };

    //========================================================================
    // If BIND logs error messages about the root key being expired,
    // you will need to update your keys.  See https://www.isc.org/bind-keys
    //========================================================================
    dnssec-validation no;
    auth-nxdomain no;
    allow-recursion { any; };
    listen-on-v6 { any; };

ir aos clientes(fazer isto em todos os clientes que tiveres) cd /etc/netplan/ -> nano 50-cloud-init.yaml
            dhcp4-overrides:
            use-routes: false
            use-dns: false
            nameservers:
                addresses: [ip of the interface of the router connected to this client] (com parenteses retos)
            routes:
            - to: 0.0.0.0/0
              via: ip of the interface of the router connected to this client (sem parenteses retos)
              metric: 100
              on-link: true    

sudo netplan try -> ENTER

<details>
  <summary>reference for the netplan</summary>
 <br>
  https://pastebin.com/uxBEM3mg
</details>

Para poder dar rdp da maquina fisica para o win-inside, tenho que dar rdp a partir do lux-inside(172.31.112.102) para o win-inside(172.31.112.101) e colocar o ip, mask, gateway e dns no win-inside
      IP              MASK          GATEWAY          DNS
(172.31.112.101, 255.255.240.0, 172.31.112.100, 172.31.112.100)

NO SERVER:
https://gist.githubusercontent.com/jdmedeiros/32bbb759d74860d1de92c6a2c34f96f1/raw/23069f5f1819098ce1fb59ada939b6a0fc272be2/Ubuntu%2520Desktop%2520on%2520EC2
iptables -A PREROUTING -t nat -i ens5 -p tcp -m multiport --dports 80,443 -j DNAT --to-destination 172.31.96.101 <- redirect de portas 80 e 443 para o website da dmz
netfilter-persistent save <- save guarda da memoria para o ficheiro(rules.v4)
iptables -A PREROUTING -t nat -i ens5 -p tcp -m multiport --dports 3389 -j DNAT --to-destination 172.31.112.102 <- rdp para o lux-inside
netfilter-persistent save 
[nano /etc/iptables/rules.v4]: -A PREROUTING -t nat -i ens5 -p tcp --dport 3390 -j DNAT --to-destination 172.31.112.101:3389 <- rdp para o win-inside
netfilter-persistent reload <- reload guarda do ficheiro(rules.v4) para a memoria
