na aws -> click the server -> actions -> networking -> Change source/destination check -> check the box 'stop'

sudo apt update && sudo apt upgrade -y
sudo apt install netfilter-persistent iptables-persistent
nano /etc/sysctl.conf -> uncomment: net.ipv4.ip_forward=1

<details>
  <summary>reference for prerouting, input, forward, output, postrouting: https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture</summary>
  <br>
  + prerouting: NAT -> change ip of the packet before entering the router
  + postrouting: NAT -> change ip of the packet after entering the router | e.g client wants to access http server on the internet, the source ip changes to the public ip of the router
  + input: FILTER(like acl) -> filters packets(IP can be public or private i think) that are going to enter any of the router's ports/IPs
  + output: FILTER(like acl) -> filters packets(IP can be public or private i think) that are now located in the router, and are destined to an IP that is not router's
  + forward: FILTER(like acl) -> like an extended acl? idk
</details>


<details>
<summary>reference for the NAT and FILTER tables(jdaniel email)</summary>
<br>
# Generated by iptables-save v1.6.0 on Thu Nov 24 23:42:12 2020
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]
-A INPUT -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -s 10.0.0.0/30 -p icmp -m icmp --icmp-type 8 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A INPUT -m limit --limit 3/min -j LOG --log-prefix "IPTABLES:INPUT:Denied: " --log-level 7
-A INPUT -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -d 172.16.0.2/32 -p tcp -m tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 172.16.0.2/32 -p tcp -m tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -d 192.168.0.2/32 -p tcp -m tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 192.168.0.2/32 -p tcp -m tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 172.16.0.0/30 -d 192.168.0.2/32 -p tcp -m tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 192.168.0.2/32 -d 172.16.0.0/30 -p tcp -m tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p tcp -m tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p tcp -m tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p tcp -m tcp --sport 20 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p tcp -m tcp --dport 20 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p tcp -m tcp --sport 21 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p tcp -m tcp --dport 21 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p icmp -m icmp --icmp-type 8 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p icmp -m icmp --icmp-type 0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 172.16.0.0/30 -d 192.168.0.0/30 -p icmp -m icmp --icmp-type 8 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 192.168.0.0/30 -d 172.16.0.0/30 -p icmp -m icmp --icmp-type 0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -d 10.0.0.0/30 -p udp -m udp --sport 53 -m state --state ESTABLISHED -j ACCEPT
-A FORWARD -s 10.0.0.0/30 -p udp -m udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
-A FORWARD -m limit --limit 3/min -j LOG --log-prefix "iptables_FORWARD_denied: " --log-level 7
-A FORWARD -j REJECT --reject-with icmp-port-unreachable
-A OUTPUT -p icmp -m icmp --icmp-type 8 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -d 10.0.0.0/30 -p icmp -m icmp --icmp-type 0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p icmp -m icmp --icmp-type 0 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
-A OUTPUT -m limit --limit 3/min -j LOG --log-prefix "IPTABLES:FORWARD:Denied: " --log-level 7
-A OUTPUT -j REJECT --reject-with icmp-port-unreachable
COMMIT
# Completed on Thu Nov 24 23:42:12 2020


#
# Outros exemplos - situações específicas
#
#bloquear tudo
iptables –P INPUT DROP
iptables –P OUTPUT DROP
iptables –P FORWARD DROP

#Para conseguir ter acesso a si mesmo
iptables –A INPUT –i lo –j ACCEPT
iptables –A OUTPUT –o lo –j ACCEPT

#Permitir ICMP
iptables -A INPUT -p icmp  -j ACCEPT
iptables -A OUTPUT -p icmp -j ACCEPT
iptables -A FORWARD -p icmp -j ACCEPT

#Permitir Regra Individual
iptables –A INPUT -i * –p tcp –-dport * -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
iptables –A OUTPUT -o * –p tcp –-sport * –m state --state RELATED,ESTABLISHED –j ACCEPT

iptables –A FORWARD -i * –p tcp –-dport * -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
iptables –A FORWARD -o * –p tcp –-sport * –m state --state RELATED,ESTABLISHED –j ACCEPT
iptables –A FORWARD -i * –p tcp –-dport * -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables –A FORWARD -o * –p tcp –-sport * –m state --state NEW,RELATED,ESTABLISHED –j ACCEPT


#Permitir Regras de Múltiplas Portas
iptables -A INPUT -p tcp/udp -i interface -m  multiport --dport X,X,X,X,X  -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp/udp -o interface -m  multiport --sport X,X,X,X,X -m state --state RELATED,ESTABLISHED -j ACCEPT

iptables -A FORWARD -p tcp/udp -i interface -m  multiport --dport X,X,X,X,X  -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p tcp/udp -o interface -m  multiport --sport X,X,X,X,X -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p tcp/udp -i interface -m  multiport --dport X,X,X,X,X  -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p tcp/udp -o interface -m  multiport --sport X,X,X,X,X -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT

#NAT/PAT - OUTSIDE
iptables -t nat -A POSTROUTING -o interface -j MASCARADE

#NAT - INSIDE - PORT FORWADING - Múltiplas Portas
iptables -t nat -A PREROUTING -i interface -p tcp/udp -m multiport --dport X,X,X,X -j DNAT --to-destination X.X.X.X  

#NAT - INSIDE - PORT FORWADING - Portas Individuais
iptables -t nat -A PREROUTING -i interface -p tcp/udp --dport X -j DNAT --to-destination X.X.X.X

#NAT - INSIDE - PORT FORWADING - Encaminhar todo o tráfico
iptables -t nat -A PREROUTING -i interface -j DNAT --to-destination X.X.X.X

apt-get install netfilter-persistent iptables-persistent

netfilter-persistent flush - limpa a memória e coloca todas as tables [filter, net, raw, mangle, security] em ACCEPT
netfilter-persistent reload - copia de /etc/iptables/rules.v4 para a memória
netfilter-persistent save  - Uso este comando para guardar em /etc/iptables/rules.v4 as regras da firewall que estão em memória

#Criar Falso Servidor de Echo - TCP
socat -v tcp-l:1234,fork exec:'/bin/cat' &
#Criar Falso Servidor de Echo - TCP
socat -v udp-l:1234,fork exec:'/bin/cat' &

#Testar Portas de Servidor - TCP
netcat -u host port
#Testar Portas de Servidor - UDP
netcat -u host port

cd /proc
find . | grep vlan
ipv4.conf.ens33.proxy_arp_pvlan=1
</details>

no srv instalar bind9, bind9-utils bind9-dns..., bind9-doc
no srv cd /etc/bind -> nano named.conf.options:
    forwarders {
            8.8.8.8;
    };

    //========================================================================
    // If BIND logs error messages about the root key being expired,
    // you will need to update your keys.  See https://www.isc.org/bind-keys
    //========================================================================
    dnssec-validation no;
    auth-nxdomain no;
    allow-recursion { any; };
    listen-on-v6 { any; };

ir ao cliente cd /etc/netplan/ -> nano 50-cloud-init.yaml
            dhcp4-overrides:
            use-routes: false
            use-dns: false
            nameservers:
                addresses: [ip of the interface of the router connected to this client] (com parenteses retos)
            routes:
            - to: 0.0.0.0/0
              via: ip of the interface of the router connected to this client (sem parenteses retos)
              metric: 100
              on-link: true    

sudo netplan try -> ENTER

<details>
  <summary>reference for the netplan</summary>
 <br>
   root@fw:/etc/netplan# cat 50-cloud-init.yaml 
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            dhcp6: false
            match:
                macaddress: 0a:0f:ec:f2:19:5b
            set-name: eth0
        eth1:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 200
            dhcp6: false
            match:
                macaddress: 0a:19:88:8e:0d:d7
            set-name: eth1
        eth2:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 300
            dhcp6: false
            match:
                macaddress: 0a:c9:85:69:e1:d3
            set-name: eth2
    version: 2
#---------------------------------------------
ubuntu@west:~$ cat /etc/netplan/50-cloud-init.yaml 
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp6: false
            dhcp4-overrides:
                use-routes: false
                use-dns: false
            nameservers:
                addresses: [8.8.8.8]
            routes:
            - to: 0.0.0.0/0
              via: 192.168.0.40
              metric: 100
              on-link: true
            match:
                macaddress: 0a:23:28:98:bb:e9
            set-name: eth0
    version: 2
ubuntu@west:~$ 

ubuntu@east:~$ cat /etc/netplan/50-cloud-init.yaml 
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp6: false
            dhcp4-overrides:
                use-routes: false
                use-dns: false
            nameservers:
                addresses: [8.8.8.8]
            routes:
            - to: 0.0.0.0/0
              via: 192.168.0.80
              metric: 100
              on-link: true
            match:
                macaddress: 0a:d6:96:d7:8f:e9
            set-name: eth0
    version: 2
</details>


https://gist.githubusercontent.com/jdmedeiros/32bbb759d74860d1de92c6a2c34f96f1/raw/23069f5f1819098ce1fb59ada939b6a0fc272be2/Ubuntu%2520Desktop%2520on%2520EC2
iptables -A PREROUTING -t nat -i ens5 -p tcp -m multiport --dports 3389 -j DNAT --to-destination 172.31.112.102
netfilter-persistent save 
